# Банковская система - Управление валютными операциями

Настольное приложение с графическим интерфейсом для банковского сотрудника, управляющего валютными операциями, курсами валют и счетами клиентов.

## Предметная область

Система предназначена для работы сотрудника банка с валютными операциями:
- Управление справочником валют
- Актуализация курсов валют
- Регистрация клиентов
- Открытие валютных счетов
- Проведение операций покупки/продажи валюты
- Просмотр истории транзакций

## Стек технологий

- **Python**: 3.12+
- **GUI**: PySide6 (Qt for Python)
- **База данных**: PostgreSQL 13+
- **Драйвер БД**: psycopg2-binary
- **ОС**: Windows, Linux, macOS (кроссплатформенность)

## Функциональность

### Демонстрируемые возможности PostgreSQL

1. **Типы данных**:
   - TEXT, VARCHAR - текстовые поля (ФИО, описания)
   - INTEGER, NUMERIC - числовые значения (суммы, курсы)
   - BOOLEAN - логические флаги (VIP, активность)
   - TIMESTAMP, DATE - временные метки и даты
   - ENUM - пользовательские типы (transaction_type, account_status)
   - ARRAY - массивы (разрешенные операции для клиента)

2. **SQL операторы**:
   - CREATE SCHEMA - создание схемы bank_system
   - CREATE TYPE - создание ENUM типов
   - CREATE TABLE - создание таблиц с ограничениями
   - INSERT - вставка данных (включая тестовые данные при создании)
   - SELECT - выборка с JOIN запросами, GROUP BY, HAVING, ORDER BY
   - ALTER TABLE - изменение структуры таблиц (добавление/удаление столбцов, изменение типов)
   - LIKE / ILIKE - шаблонный поиск
   - POSIX regex (~, ~*, !~, !~*) - регулярные выражения
   - Строковые функции (UPPER, LOWER, SUBSTRING, TRIM, LPAD, RPAD, CONCAT, LENGTH)
   - Агрегатные функции (COUNT, SUM, AVG, MIN, MAX)
   - Все типы JOIN (INNER, LEFT, RIGHT, FULL)

3. **Ограничения**:
   - NOT NULL - обязательные поля
   - UNIQUE - уникальность (код валюты, паспорт, номер счета)
   - CHECK - проверка диапазонов (курсы > 0, баланс >= 0, дата рождения < сегодня)

4. **Ключи**:
   - PRIMARY KEY - первичные ключи (SERIAL)
   - FOREIGN KEY - внешние ключи с ON DELETE CASCADE/RESTRICT
   - ON UPDATE CASCADE - каскадное обновление

5. **Механизмы ссылочной целостности**:
   - Демонстрация попыток нарушения связей
   - Каскадное удаление зависимых записей (счета → транзакции)
   - Предотвращение удаления при наличии ссылок (валюта → курсы)

### Возможности приложения

1. **Подключение к БД** - диалог с параметрами подключения
2. **Создание схемы** - автоматическое развертывание БД с тестовыми данными
3. **Добавление данных** - модальные формы для каждой таблицы:
   - Валюты
   - Курсы валют
   - Клиенты
   - Валютные счета
   - Транзакции
4. **Просмотр данных** - табличное представление с фильтрами:
   - Фильтр по базовой валюте (для курсов)
   - Фильтр по валюте счета
   - Фильтр по типу транзакции
   - Фильтр по дате
   - JOIN-запросы для связанных данных
5. **ALTER TABLE - Изменение структуры БД** (Новое!):
   - Добавление и удаление столбцов
   - Переименование столбцов и таблиц
   - Изменение типов данных
   - Управление ограничениями (NOT NULL, CHECK, UNIQUE, FOREIGN KEY)
   - Транзакционное выполнение с откатом при ошибках
6. **Расширенный SELECT** (Новое!):
   - Выбор конкретных столбцов для вывода
   - Фильтрация через WHERE
   - Сортировка ORDER BY
   - Группировка GROUP BY
   - Агрегатные функции (COUNT, SUM, AVG, MIN, MAX)
   - Фильтрация групп через HAVING
   - Отображение сформированного SQL
7. **Поиск по тексту** (Новое!):
   - Шаблонный поиск LIKE (с символами % и _)
   - Регистронезависимый поиск ILIKE
   - POSIX регулярные выражения (~, ~*, !~, !~*)
   - Поиск по любым текстовым полям таблиц
8. **Функции работы со строками** (Новое!):
   - UPPER / LOWER - преобразование регистра
   - SUBSTRING - извлечение подстрок
   - TRIM / LTRIM / RTRIM - удаление пробелов
   - LPAD / RPAD - дополнение строк
   - CONCAT - объединение строк
   - LENGTH - получение длины строки
   - Наглядное отображение результатов
9. **Мастер соединений (JOIN)** (Новое!):
   - Визуальный выбор таблиц для соединения
   - Выбор полей связывания
   - Типы соединений: INNER, LEFT, RIGHT, FULL
   - Выбор столбцов для вывода
   - Сортировка и фильтрация результатов
   - Отображение сформированного SQL
10. **Обработка ошибок** - понятные сообщения об ошибках БД:
    - Нарушение UNIQUE
    - Нарушение NOT NULL
    - Нарушение CHECK
    - Нарушение FOREIGN KEY
    - Ошибки типов данных
    - Ошибки подключения
11. **Логирование** - запись всех операций в файл с временными метками

## Установка и запуск

### Предварительные требования

1. **Python 3.12 или выше**
   ```bash
   python --version
   ```

2. **PostgreSQL 13 или выше**
   ```bash
   brew services start postgresql
   ```

### Установка зависимостей

```bash
pip install -r requirements.txt
```

### Настройка базы данных

1. Создайте базу данных (опционально):
   ```bash
   createdb bank_db
   ```

### Запуск приложения

```bash
python main.py
```

### Первый запуск

1. При запуске появится окно подключения к БД
2. Введите параметры:
   - **Хост**: localhost
   - **Порт**: 5433
   - **База данных**: postgres (или bank_db)
   - **Пользователь**: ваш username (узнать: `whoami`)
   - **Пароль**: оставьте пустым для локальной установки
3. Нажмите "Подключиться"
4. После успешного подключения нажмите **"Создать схему и таблицы"**
5. Схема будет создана с тестовыми данными!

## Структура базы данных

### Таблицы

1. **currencies** - справочник валют (8 валют в тестовых данных)
2. **exchange_rates** - курсы валют (8 пар валют с актуальными курсами)
3. **clients** - клиенты банка (6 клиентов)
4. **currency_accounts** - валютные счета (15 счетов в разных валютах)
5. **transactions** - транзакции (20 операций покупки/продажи)

### Связи

- exchange_rates → currencies (FOREIGN KEY, ON DELETE RESTRICT)
- clients: уникальный паспорт, массив разрешенных операций
- currency_accounts → clients (FOREIGN KEY, ON DELETE CASCADE)
- currency_accounts → currencies (FOREIGN KEY, ON DELETE RESTRICT)
- transactions → currency_accounts (FOREIGN KEY, ON DELETE CASCADE)
- transactions → currencies (FOREIGN KEY, ON DELETE RESTRICT)

### ENUM типы

- **transaction_type**: BUY, SELL, TRANSFER, DEPOSIT, WITHDRAWAL
- **account_status**: ACTIVE, BLOCKED, CLOSED

## Тестовые данные

После создания схемы в базе автоматически появятся:

### Валюты (8 шт)
- RUB (Российский рубль)
- USD (Доллар США)
- EUR (Евро)
- GBP (Фунт стерлингов)
- CNY (Китайский юань)
- JPY (Японская йена)
- CHF (Швейцарский франк)
- TRY (Турецкая лира - неактивна)

### Клиенты (6 человек)
- Смирнов Алексей Петрович (VIP)
- Кузнецова Мария Ивановна
- Попов Дмитрий Сергеевич (VIP)
- Васильева Елена Николаевна
- Петров Игорь Владимирович
- Новикова Ольга Александровна (VIP)

### Валютные счета (15 шт)
Счета в различных валютах с балансами от 800 до 520,000 единиц

### Транзакции (20 операций)
Операции покупки/продажи валюты за сентябрь-октябрь 2024

## Примеры использования

### Просмотр всех клиентов

1. Нажмите **"Показать данные"**
2. Перейдите на вкладку **"Клиенты"**
3. Нажмите **"Загрузить данные"**
4. Увидите список из 6 клиентов с их данными

### Просмотр транзакций по типу

1. Откройте **"Показать данные"** → **"Транзакции"**
2. Выберите тип операции (например, BUY)
3. Нажмите **"Применить фильтр"**
4. Увидите только операции покупки валюты

### Добавление нового курса

1. Откройте **"Внести данные"** → **"Курсы валют"**
2. Заполните:
   - Базовая валюта: EUR
   - Целевая валюта: USD
   - Курс покупки: 1.08
   - Курс продажи: 1.10
   - Обновил: Ваше ФИО
3. Нажмите **"Добавить курс"**

### Использование ALTER TABLE

1. Нажмите **"ALTER TABLE - Изменить структуру БД"**
2. Выберите нужную вкладку:
   - **"Добавить столбец"**: добавьте новый столбец с ограничениями
   - **"Удалить столбец"**: удалите ненужный столбец
   - **"Переименовать столбец"**: измените имя столбца
   - **"Переименовать таблицу"**: измените имя таблицы
   - **"Изменить тип"**: измените тип данных столбца
   - **"Ограничения"**: установите/уберите NOT NULL, добавьте/удалите CHECK, UNIQUE, FOREIGN KEY

### Расширенный SELECT с агрегацией

1. Нажмите **"Расширенный SELECT"**
2. Выберите таблицу: `transactions`
3. SELECT столбцы: `transaction_type, COUNT(*) as count, SUM(amount) as total`
4. GROUP BY: `transaction_type`
5. ORDER BY: `count DESC`
6. Нажмите **"Выполнить запрос"**
7. Увидите статистику по типам транзакций

### Поиск по тексту с LIKE

1. Нажмите **"Поиск по тексту (LIKE / REGEX)"**
2. Выберите таблицу: `clients`
3. Выберите столбец: `full_name`
4. Тип поиска: `LIKE (шаблон)`
5. Шаблон: `%Петр%`
6. Нажмите **"Выполнить поиск"**
7. Найдутся все клиенты с "Петр" в имени

### Поиск с регулярными выражениями

1. Откройте **"Поиск по тексту"**
2. Таблица: `clients`, Столбец: `email`
3. Тип поиска: `~ (regex)`
4. Шаблон: `.*@gmail\.com`
5. Нажмите **"Выполнить поиск"**
6. Найдутся все клиенты с Gmail

### Работа со строками - UPPER

1. Нажмите **"Функции работы со строками"**
2. Выберите таблицу: `clients`
3. Выберите столбец: `full_name`
4. Функция: `UPPER (верхний регистр)`
5. Нажмите **"Применить функцию"**
6. Увидите имена клиентов в верхнем регистре

### Работа со строками - SUBSTRING

1. Откройте **"Функции работы со строками"**
2. Таблица: `clients`, Столбец: `phone`
3. Функция: `SUBSTRING (подстрока)`
4. Начало: `1`, Длина: `7`
5. Нажмите **"Применить функцию"**
6. Увидите первые 7 символов телефона

### Мастер соединений - JOIN

1. Нажмите **"Мастер соединений (JOIN)"**
2. Первая таблица: `clients`
3. Поле связи (таблица 1): `client_id`
4. Вторая таблица: `currency_accounts`
5. Поле связи (таблица 2): `client_id`
6. Тип соединения: `INNER (внутреннее)`
7. Столбцы для вывода: `t1.full_name, t2.account_number, t2.balance, t2.currency_code`
8. Нажмите **"Выполнить соединение"**
9. Увидите клиентов с их счетами

### Демонстрация ссылочной целостности

**ON DELETE RESTRICT:**
- Попробуйте удалить валюту USD (используется в курсах и счетах)
- Система не позволит удалить и выдаст ошибку

**ON DELETE CASCADE:**
- При удалении клиента автоматически удалятся его счета
- При удалении счета автоматически удалятся его транзакции

### Демонстрация ограничений

**UNIQUE:**
- Попробуйте добавить клиента с паспортом "4512 678901" (уже существует)
- Получите ошибку уникальности

**CHECK:**
- Попробуйте добавить курс с отрицательным значением
- Получите ошибку CHECK constraint

**NOT NULL:**
- Попробуйте добавить клиента без ФИО
- Получите ошибку обязательного поля

## Логирование

Все действия записываются в файл `mlops_ddos_app.log`:
- Подключения к БД
- Выполненные DDL/DML операции
- Ошибки и исключения
- Время выполнения операций

## Обработка ошибок

Приложение перехватывает все ошибки PostgreSQL и отображает понятные сообщения:

- **UNIQUE violation**: "Запись с таким значением уже существует"
- **NOT NULL violation**: "Поле 'имя_поля' обязательно для заполнения"
- **CHECK violation**: "Значение не соответствует ограничению"
- **FOREIGN KEY violation**: "Ссылка на несуществующую запись" или "Невозможно удалить"
- **Type mismatch**: "Неверный тип данных"

## Структура проекта

```
project1/
├── main.py                  # Главное окно приложения
├── gui_windows.py           # Диалоговые окна
├── db_manager.py            # Менеджер работы с БД
├── logger_config.py         # Настройка логирования
├── database_schema.sql      # SQL скрипт создания схемы + тестовые данные
├── requirements.txt         # Зависимости Python
├── README.md                # Документация
└── bank_app.log             # Лог-файл
```

## Технические детали

- **Parameterized queries**: Все INSERT операции используют параметризованные запросы для защиты от SQL-инъекций
- **Транзакции**: Автоматический ROLLBACK при ошибках, все изменения выполняются атомарно
- **Индексы**: Созданы для оптимизации запросов по валютам, датам, типам
- **Модальные окна**: Родительское окно блокируется во время работы с диалогами
- **JOIN запросы**: Поддержка всех типов соединений (INNER, LEFT, RIGHT, FULL)
- **Динамическое построение SQL**: Все расширенные запросы формируются динамически и отображаются пользователю
- **Information Schema**: Использование системных таблиц PostgreSQL для получения метаданных (списки таблиц, столбцов, типов данных)
- **Регулярные выражения**: Полная поддержка POSIX regex для гибкого поиска
- **Строковые функции**: Применение встроенных функций PostgreSQL для обработки текста
- **Агрегация и группировка**: Поддержка GROUP BY, HAVING и агрегатных функций
- **ALTER TABLE**: Транзакционное изменение структуры БД с обработкой всех типов ошибок
- **Кроссплатформенность**: Qt/PySide6 обеспечивает единый вид на всех ОС

## Автор

Петушкова Дарья Денисовна

## Лицензия

Учебный проект, свободное использование.
